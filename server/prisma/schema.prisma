// This is your Prisma schema file for the Classify platform
// Run: npx prisma migrate dev --name init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum Role {
  ADMIN
  INSTRUCTOR
  STUDENT
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum Semester {
  FIRST
  SECOND
}

enum ExamType {
  WRITTEN
  CBT
  PRACTICAL
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

enum CbtQuestionType {
  MULTIPLE_CHOICE
  // ESSAY and SHORT_ANSWER reserved for future
}

enum SyncStatus {
  PENDING
  SUCCESS
  FAILED
  SKIPPED
  PARTIAL
}

enum ResourceType {
  VIDEO
  READING
  SLIDE
  OTHER
}

// ─── Core User / Auth ─────────────────────────────────────────────────────────

model User {
  id        String    @id @default(cuid())
  email     String    @unique
  password  String
  role      Role
  isActive  Boolean   @default(true)
  lastLogin DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  student    Student?
  instructor Instructor?
  admin      Admin?
  resources  Resource[]
}

// ─── Admin ────────────────────────────────────────────────────────────────────

model Admin {
  id        String   @id @default(cuid())
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fullName  String
  phone     String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Student ──────────────────────────────────────────────────────────────────

model Student {
  id           String      @id @default(cuid())
  userId       String      @unique
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  matricNumber String      @unique
  firstName    String
  lastName     String
  middleName   String?
  gender       Gender
  dateOfBirth  DateTime?
  phone        String?
  address      String?
  avatarUrl    String?
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  facultyId    String?
  faculty      Faculty?    @relation(fields: [facultyId], references: [id])
  level        Int         @default(100) // 100, 200, 300, 400, 500
  entryYear    String // e.g. "2023"
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  enrollments Enrollment[]
  attendances Attendance[]
  scores      Score[]
  cbtAttempts CbtAttempt[]

  @@index([departmentId])
  @@index([facultyId])
  @@index([level])
  @@index([matricNumber])
}

// ─── Instructor ───────────────────────────────────────────────────────────────

model Instructor {
  id            String      @id @default(cuid())
  userId        String      @unique
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  staffId       String?     @unique
  firstName     String
  lastName      String
  phone         String?
  departmentId  String?
  department    Department? @relation(fields: [departmentId], references: [id])
  facultyId     String?
  faculty       Faculty?    @relation(fields: [facultyId], references: [id])
  avatarUrl     String?
  qualification String?
  isActive      Boolean     @default(true)
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  courseAssignments CourseInstructor[]
}

// ─── Academic Session ─────────────────────────────────────────────────────────

model AcademicSession {
  id        String    @id @default(cuid())
  title     String    @unique // e.g. "2024/2025"
  isCurrent Boolean   @default(false)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime  @default(now())

  semesters Semester_[]
}

model Semester_ {
  id        String          @id @default(cuid())
  sessionId String
  session   AcademicSession @relation(fields: [sessionId], references: [id])
  name      Semester
  isCurrent Boolean         @default(false)
  startDate DateTime?
  endDate   DateTime?
  createdAt DateTime        @default(now())

  attendances    Attendance[]
  exams          Exam[]
  cbtExams       CbtExam[]
  activeSessions AttendanceSession[]
  resources      Resource[]

  @@unique([sessionId, name])
}

// ─── Course ───────────────────────────────────────────────────────────────────

model Course {
  id          String       @id @default(cuid())
  code        String?      @unique // e.g. "CSC201"
  title       String
  description String?
  creditUnits Int?
  levels      Int[]
  semesters   Semester[]
  departments Department[]
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  enrollments    Enrollment[]
  instructors    CourseInstructor[]
  attendances    Attendance[]
  exams          Exam[]
  cbtExams       CbtExam[]
  questions      CbtQuestion[]
  activeSessions AttendanceSession[]
  topics         CourseTopic[]
  resources      Resource[]
}

model CourseTopic {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  description String?
  order       Int
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  questions CbtQuestion[]
  resources Resource[]

  @@index([courseId])
  @@index([courseId, order])
}

model CourseInstructor {
  id           String     @id @default(cuid())
  courseId     String
  course       Course     @relation(fields: [courseId], references: [id])
  instructorId String
  instructor   Instructor @relation(fields: [instructorId], references: [id])
  isPrimary    Boolean    @default(true)
  assignedAt   DateTime   @default(now())

  @@unique([courseId, instructorId])
}

model Enrollment {
  id         String   @id @default(cuid())
  studentId  String
  student    Student  @relation(fields: [studentId], references: [id])
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id])
  session    String // e.g. "2024/2025"
  semester   Semester
  enrolledAt DateTime @default(now())

  @@unique([studentId, courseId, session, semester])
}

// ─── Attendance ───────────────────────────────────────────────────────────────

model Attendance {
  id         String           @id @default(cuid())
  studentId  String
  student    Student          @relation(fields: [studentId], references: [id])
  courseId   String
  course     Course           @relation(fields: [courseId], references: [id])
  semesterId String
  semester   Semester_        @relation(fields: [semesterId], references: [id])
  date       DateTime         @db.Date
  status     AttendanceStatus @default(PRESENT)
  note       String?
  markedById String? // userId of who marked it
  createdAt  DateTime         @default(now())

  @@unique([studentId, courseId, date])
  @@index([courseId, date])
}

// ─── Examination (Written) ────────────────────────────────────────────────────

model Exam {
  id                  String    @id @default(cuid())
  courseId            String
  course              Course    @relation(fields: [courseId], references: [id])
  semesterId          String
  semester            Semester_ @relation(fields: [semesterId], references: [id])
  title               String
  type                ExamType  @default(WRITTEN)
  examDate            DateTime?
  totalMarks          Float     @default(100)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  isArchived          Boolean   @default(false)
  deletionScheduledAt DateTime?

  scores Score[]
}

model Score {
  id        String   @id @default(cuid())
  examId    String
  exam      Exam     @relation(fields: [examId], references: [id])
  studentId String
  student   Student  @relation(fields: [studentId], references: [id])
  score     Float
  grade     String? // auto-computed: A, B, C, D, F
  remark    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([examId, studentId])
}

// ─── CBT ──────────────────────────────────────────────────────────────────────

model CbtQuestion {
  id            String          @id @default(cuid())
  courseId      String
  course        Course          @relation(fields: [courseId], references: [id])
  topicId       String?
  topic         CourseTopic?    @relation(fields: [topicId], references: [id])
  type          CbtQuestionType @default(MULTIPLE_CHOICE)
  questionText  String
  optionA       String
  optionB       String
  optionC       String
  optionD       String
  correctOption String // "A", "B", "C", or "D"
  explanation   String? // shown after exam
  marks         Float           @default(1)
  difficulty    String? // "EASY", "MEDIUM", "HARD"
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  examQuestions CbtExamQuestion[]
  answers       CbtAnswer[]
}

model CbtExam {
  id                  String    @id @default(cuid())
  courseId            String
  course              Course    @relation(fields: [courseId], references: [id])
  semesterId          String
  semester            Semester_ @relation(fields: [semesterId], references: [id])
  title               String
  category            String?   @default("EXAM") // "TEST", "EXAM"
  mode                String?   @default("CBT") // "CBT", "WRITTEN", "PRACTICAL"
  instructions        String?
  topicIds            String[]  @default([])
  numQuestions        Int?      @default(0)
  durationMinutes     Int       @default(60)
  totalMarks          Float     @default(100)
  passMark            Float     @default(50)
  isPublished         Boolean   @default(false)
  startWindow         DateTime? // earliest a student can start
  endWindow           DateTime? // deadline — no new attempts after this
  allowReview         Boolean   @default(true)
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  isArchived          Boolean   @default(false)
  deletionScheduledAt DateTime?

  questions CbtExamQuestion[]
  attempts  CbtAttempt[]
}

model CbtExamQuestion {
  id         String      @id @default(cuid())
  examId     String
  exam       CbtExam     @relation(fields: [examId], references: [id])
  questionId String
  question   CbtQuestion @relation(fields: [questionId], references: [id])
  order      Int

  @@unique([examId, questionId])
  @@unique([examId, order])
}

model CbtAttempt {
  id          String    @id @default(cuid())
  examId      String
  exam        CbtExam   @relation(fields: [examId], references: [id])
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id])
  startedAt   DateTime  @default(now())
  submittedAt DateTime?
  score       Float?
  percentage  Float?
  isPassed    Boolean?
  isCompleted Boolean   @default(false)
  ipAddress   String?
  createdAt   DateTime  @default(now())

  answers CbtAnswer[]

  @@unique([examId, studentId]) // one attempt per student per exam
}

model CbtAnswer {
  id         String      @id @default(cuid())
  attemptId  String
  attempt    CbtAttempt  @relation(fields: [attemptId], references: [id])
  questionId String
  question   CbtQuestion @relation(fields: [questionId], references: [id])
  selected   String? // "A", "B", "C", "D" or null if skipped
  isCorrect  Boolean?
  createdAt  DateTime    @default(now())

  @@unique([attemptId, questionId])
}

// ─── Cloud Sync ───────────────────────────────────────────────────────────────

model SyncLog {
  id          String     @id @default(cuid())
  triggeredBy String // userId
  status      SyncStatus @default(PENDING)
  localStatus SyncStatus?
  cloudStatus SyncStatus?
  recordCount Int?
  errorMsg    String?
  startedAt   DateTime   @default(now())
  completedAt DateTime?
}

model AttendanceSession {
  id           String      @id @default(cuid())
  courseId     String
  course       Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  semesterId   String
  semester     Semester_   @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])
  level        Int?
  startTime    DateTime    @default(now())
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([courseId])
  @@index([semesterId])
  @@index([departmentId])
}

model Faculty {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  departments Department[]
  students    Student[]
  instructors Instructor[]
}

model Department {
  id        String   @id @default(cuid())
  name      String
  facultyId String
  faculty   Faculty  @relation(fields: [facultyId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  students           Student[]
  instructors        Instructor[]
  courses            Course[]
  attendanceSessions AttendanceSession[]

  @@unique([facultyId, name])
}

model Resource {
  id           String       @id @default(cuid())
  courseId     String
  course       Course       @relation(fields: [courseId], references: [id], onDelete: Cascade)
  semesterId   String
  semester     Semester_    @relation(fields: [semesterId], references: [id], onDelete: Cascade)
  topicId      String?
  topic        CourseTopic? @relation(fields: [topicId], references: [id])
  title        String
  description  String?
  type         ResourceType
  url          String
  isExternal   Boolean      @default(false)
  fileSize     Int?
  uploadedById String
  uploadedBy   User         @relation(fields: [uploadedById], references: [id])
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([courseId])
  @@index([semesterId])
}
